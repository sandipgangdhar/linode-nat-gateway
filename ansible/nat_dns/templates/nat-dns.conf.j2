# /etc/dnsmasq.d/nat-dns.conf
# Auto-generated by Ansible (nat_dns role). Do not edit manually.
#
# Purpose:
# - Listen ONLY on the VLAN VIP (the default gateway / DNS IP for private nodes)
# - Forward all queries to the upstream DNS servers discovered from systemd-resolved
# - Provide local caching to reduce DNS latency and egress

# Don't use /etc/resolv.conf â€“ we explicitly configure upstreams
no-resolv

# Don't read /etc/hosts for DNS; keep it pure forwarding
no-hosts

# Basic safety & cache
domain-needed
bogus-priv
cache-size=1000

# Upstream DNS servers (auto-discovered via resolvectl on {{ pub_if }})
{% for ip in nat_dns_upstreams %}
server={{ ip }}
{% endfor %}

# Listen only on the VLAN VIP (shared default gateway for private nodes)
# vlan_vip is already defined in nat group_vars (or nat_<pair>.yml in multi-pair mode)
listen-address={{ vlan_vip }}

# Bind only to the specified address, so we don't fight systemd-resolved on 127.0.0.53
bind-interfaces

# Optional: log queries during debugging
#log-queries
#log-facility=/var/log/dnsmasq-nat.log
