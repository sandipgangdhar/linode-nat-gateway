---
- hosts: nat
  become: true
  gather_facts: yes

  vars:
    # For VIP/FIP logic inside templates
    fip_ip: "{{ fip | default(shared_ipv4) }}"
    vrrp_instance: "VGW1"
    vrrp_interface: "{{ vlan_if }}"
    vrrp_router_id: 51
    vrrp_auth_pass: "changeme"

    # Toggle conntrack replication
    enable_conntrack: true

  pre_tasks:
    - name: Sanityâ€”required vars present
      ansible.builtin.assert:
        that:
          - fip_ip is defined
          - vlan_vip is defined
          - pub_if is defined
          - vlan_if is defined
          - dcid is defined
        fail_msg: "Missing one of: fip/shared_ipv4, vlan_vip, pub_if, vlan_if, dcid"
      tags: [always]

    - name: Compute vlan_cidr from vlan_vip
      ansible.builtin.set_fact:
        vlan_cidr: "{{ vlan_vip.split('/')[0].rsplit('.', 1)[0] + '.0/' + vlan_vip.split('/')[1] }}"
      tags: [always]

    # Stop auto updates to avoid apt/dpkg lock races
    - name: Stop auto-update timers (avoid apt lock issues)
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        enabled: false
      loop:
        - unattended-upgrades
        - apt-daily.service
        - apt-daily-upgrade.service
        - apt-daily.timer
        - apt-daily-upgrade.timer
      failed_when: false
      ignore_errors: true

    - name: Wait for dpkg locks
      ansible.builtin.shell: |
        for i in {1..60}; do
          if ! fuser /var/lib/dpkg/lock >/dev/null 2>&1; then exit 0; fi
          sleep 5
        done
        exit 1
      changed_when: false

    - name: Ensure dpkg configured
      ansible.builtin.shell: dpkg --configure -a
      changed_when: false
      failed_when: false

  roles:
    - role: nat_ha
      tags: [nat_ha]

    - role: nat_conntrack
      when: enable_conntrack | bool
      tags: [nat_conntrack]

  post_tasks:
    - name: Start auto-update timers again
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
      loop:
        - apt-daily.timer
        - apt-daily-upgrade.timer
        - unattended-upgrades
      ignore_errors: true
