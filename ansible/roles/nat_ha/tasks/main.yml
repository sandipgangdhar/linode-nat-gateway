---
# roles/nat_ha/tasks/main.yml

- name: Ensure base packages
  ansible.builtin.apt:
    name:
      - "keepalived=1:2.2.8-1build2"
      - nftables
      - conntrack
      - jq
      - curl
      - ca-certificates
      - vim
    state: present
    update_cache: yes
    cache_valid_time: 3600
    lock_timeout: "{{ apt_lock_timeout | default(600) }}"
    install_recommends: no
  register: _apt_result
  retries: 5
  delay: 10
  until: _apt_result is succeeded

# Enable forwarding & relax rp_filter for asymmetric paths
- name: Ensure kernel forwarding and rp_filter are set for NAT
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: true
    state: present
    reload: true
  loop:
    - { name: 'net.ipv4.ip_forward', value: '1' }
    - { name: 'net.ipv4.conf.all.rp_filter', value: '0' }
    - { name: 'net.ipv4.conf.eth0.rp_filter', value: '0' }
    - { name: 'net.ipv4.conf.eth1.rp_filter', value: '0' }

# Canonical public IP used for SNAT (prefer shared FIP)
- name: Resolve public IP to use for SNAT (prefer shared IPv4)
  ansible.builtin.set_fact:
    nat_ha_public_ip: >-
      {{ nat_ha_shared_ipv4
         | default(shared_ipv4, true)
         | default(nat_ha_fip, true)
         | default(fip, true) }}

- name: Validate that a public IP is provided
  ansible.builtin.assert:
    that:
      - nat_ha_public_ip is defined
      - (nat_ha_public_ip | string) | length > 0
    fail_msg: >
      Please set one of: nat_ha_shared_ipv4 (preferred), shared_ipv4,
      nat_ha_fip, or fip in inventory/group_vars (Terraform writes shared_ipv4).

# Make sure services are enabled (state will be handled via notify below)
- name: Enable nftables/keepalived
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
  loop:
    - nftables
    - keepalived
  become: yes

# ---------- lelastic (Linode ECMP/BGP helper) ----------
- name: Check if lelastic already installed
  ansible.builtin.stat:
    path: /usr/local/bin/lelastic
  register: lelastic_bin

- name: Download lelastic (compressed)
  ansible.builtin.get_url:
    url: "https://github.com/linode/lelastic/releases/download/{{ lelastic_version | default('v0.0.6') }}/lelastic.gz"
    dest: /tmp/lelastic.gz
    mode: "0644"
  when: not lelastic_bin.stat.exists

- name: Install lelastic
  ansible.builtin.shell: |
    set -euo pipefail
    gunzip -c /tmp/lelastic.gz > /usr/local/bin/lelastic
    chmod 0755 /usr/local/bin/lelastic
  args:
    executable: /bin/bash
    creates: /usr/local/bin/lelastic
  when: not lelastic_bin.stat.exists

- name: Remove lelastic.gz after install
  ansible.builtin.file:
    path: /tmp/lelastic.gz
    state: absent
  when: not lelastic_bin.stat.exists

- name: Install lelastic systemd unit (default = secondary)
  ansible.builtin.template:
    src: lelastic.service.j2
    dest: /etc/systemd/system/lelastic.service
    mode: "0644"
  notify:
    - Reload systemd
    - Restart lelastic

# ---------- nftables ----------
- name: Ensure /etc/nftables.d exists
  ansible.builtin.file:
    path: /etc/nftables.d
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure /etc/nftables.conf includes /etc/nftables.d/*.nft
  ansible.builtin.blockinfile:
    path: /etc/nftables.conf
    create: true
    mode: "0644"
    owner: root
    group: root
    marker: "# {mark} ANSIBLE nat_ha include"
    block: |
      # Keep your base rules here if any (do not flush ruleset unless you own the whole file)
      include "/etc/nftables.d/*.nft"
  notify: Restart nftables

- name: Install nftables NAT table (NAT Gateway)
  ansible.builtin.template:
    src: nat.nft.j2
    dest: /etc/nftables.d/nat-natgw.nft
    owner: root
    group: root
    mode: "0644"
  notify: Restart nftables
  become: yes

- name: Remove legacy /etc/nftables.d/nat.nft to avoid duplicate rules
  ansible.builtin.file:
    path: /etc/nftables.d/nat.nft
    state: absent
  notify: Restart nftables

- name: Force reload nftables ruleset from /etc/nftables.conf
  ansible.builtin.command: nft -f /etc/nftables.conf
  changed_when: false

# ---------- keepalived ----------
- name: Install keepalived notify script
  ansible.builtin.template:
    src: notify.sh.j2
    dest: /usr/local/sbin/keepalived-notify.sh
    mode: '0755'
  become: yes
  notify: Restart keepalived

- name: Install keepalived.conf
  ansible.builtin.template:
    src: keepalived.conf.j2
    dest: /etc/keepalived/keepalived.conf
    mode: "0644"
  notify: Restart keepalived

# Keep lelastic running (role ensures the unit exists)
- name: Start lelastic as secondary by default
  ansible.builtin.systemd:
    name: lelastic
    state: started
    enabled: true
  become: yes
