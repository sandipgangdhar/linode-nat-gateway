#!/usr/bin/env bash
set -euo pipefail

# Supports either explicit notify_* hooks or single global 'notify'.

PUB_IF="{{ pub_if | default('eth0') }}"
FIP="{{ fip }}/32"
ROLE_FILE="/run/nat-ha-role"

log() { echo "[keepalived-notify] $(date -Is) $*"; }

# Normalize action/state from keepalived
ACTION="${1:-}"
if [[ -z "$ACTION" && $# -ge 3 ]]; then
  ACTION="${3,,}"   # STATE from 'notify' is the 3rd arg
else
  ACTION="${ACTION,,}"
fi

write_role_metric() {
  echo "${1}" > "${ROLE_FILE}"
  chmod 0644 "${ROLE_FILE}" || true
}

ensure_fip() {
  if ! ip -4 addr show dev "$PUB_IF" | grep -q " ${FIP}\b"; then
    ip addr add "$FIP" dev "$PUB_IF" label "${PUB_IF}:fip"
    if command -v arping >/dev/null 2>&1; then
      arping -U -I "$PUB_IF" "${FIP%/*}" -c 3 || true
    fi
  fi
}

remove_fip() {
  ip addr del "$FIP" dev "$PUB_IF" 2>/dev/null || true
}

case "$ACTION" in
  master)
    log "MASTER: adding ${FIP} on ${PUB_IF}"
    write_role_metric "master"
    ensure_fip
    systemctl try-restart lelastic || true
    ;;
  backup|fault|stop)
    log "BACKUP/FAULT/STOP: removing ${FIP} from ${PUB_IF}"
    write_role_metric "backup"
    remove_fip
    systemctl try-restart lelastic || true
    ;;
  *)
    log "Unknown/ignored action '$ACTION' (expected master|backup|fault|stop)"
    ;;
esac
