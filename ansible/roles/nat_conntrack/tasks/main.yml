---
# roles/nat_conntrack/tasks/main.yml

# ---------------------------
# Pre-checks / interface facts
# ---------------------------
- name: Assert required vars (safe guard)
  ansible.builtin.assert:
    that:
      - vlan_if is defined
      - ct_local_ip is defined
      - ct_peer_ip is defined
  tags: [nat_conntrack]

# Try to read IPv4 from gathered facts (ansible_{{vlan_if}}.ipv4.address)
- name: Detect IPv4 on {{ vlan_if }} from gathered facts
  ansible.builtin.set_fact:
    vlan_if_ip: "{{ (hostvars[inventory_hostname]['ansible_' ~ vlan_if]['ipv4'].address) | default('') }}"
  tags: [nat_conntrack]

# Fallback to ip(8) if facts don’t have it (or are missing)
- name: Fallback — detect IPv4 on {{ vlan_if }} via ip(8)
  ansible.builtin.command: "ip -o -4 addr show dev {{ vlan_if }}"
  register: ip_addr_show
  changed_when: false
  when: vlan_if_ip | default('') == ''
  tags: [nat_conntrack]

- name: Parse fallback IPv4
  ansible.builtin.set_fact:
    vlan_if_ip: "{{ (ip_addr_show.stdout | regex_search('\\d+\\.\\d+\\.\\d+\\.\\d+')) | default('') }}"
  when: vlan_if_ip | default('') == ''
  tags: [nat_conntrack]

- name: Assert ct_local_ip is configured on {{ vlan_if }}
  ansible.builtin.assert:
    that:
      - vlan_if_ip != ''
      - vlan_if_ip == ct_local_ip
    fail_msg: >-
      ct_local_ip ({{ ct_local_ip }}) is not configured on {{ vlan_if }}.
      Detected: {{ vlan_if_ip or 'none' }}. Fix the interface IPs on this host, then re-run.
  tags: [nat_conntrack]

# ---------------------------
# Kernel / sysctl prerequisites
# ---------------------------
- name: Enable conntrack accounting
  ansible.posix.sysctl:
    name: net.netfilter.nf_conntrack_acct
    value: "1"
    state: present
    sysctl_set: yes
    reload: yes
  tags: [nat_conntrack]

- name: Ensure nf_conntrack kernel module is loaded
  ansible.builtin.modprobe:
    name: nf_conntrack
    state: present
  tags: [nat_conntrack]

- name: Persist nf_conntrack module across reboots
  ansible.builtin.lineinfile:
    path: /etc/modules-load.d/conntrack.conf
    create: yes
    line: nf_conntrack
    mode: "0644"
  tags: [nat_conntrack]

# ---------------------------
# Packages
# ---------------------------
- name: Install conntrack utilities
  ansible.builtin.apt:
    name:
      - conntrackd
      - conntrack
      - nftables
    state: present
    update_cache: yes
  when: ansible_facts.os_family == "Debian"
  tags: [nat_conntrack]

# ---------------------------
# Configuration files
# ---------------------------
- name: Deploy conntrackd.conf
  ansible.builtin.template:
    src: conntrackd.conf.j2
    dest: /etc/conntrackd/conntrackd.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart conntrackd
  tags: [nat_conntrack]

- name: Drop nftables rule to allow conntrack sync from peer
  ansible.builtin.template:
    src: 20-conntrack-sync.nft.j2
    dest: /etc/nftables.d/20-conntrack-sync.nft
    owner: root
    group: root
    mode: "0644"
  notify: Reload nftables
  when: ansible_facts.os_family == "Debian"
  tags: [nat_conntrack]

# ---------------------------
# Runtime dirs / state
# ---------------------------
- name: Ensure conntrackd state/runtime dirs exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /var/lib/conntrackd
    - /var/lib/conntrackd/dumps
    - /var/lib/conntrackd/filters
    - /var/lib/conntrackd/sync
    - /var/run/conntrackd
  tags: [nat_conntrack]

# ---------------------------
# Service state check + preflight
# ---------------------------
- name: Gather service facts
  ansible.builtin.service_facts:
  tags: [nat_conntrack]

- name: Detect if conntrackd is running
  ansible.builtin.set_fact:
    conntrackd_running: >-
      {{ (services.get('conntrackd.service') and
         services['conntrackd.service'].state == 'running') | default(false) }}
  tags: [nat_conntrack]

- name: Remove stale lock if service not running
  ansible.builtin.file:
    path: /var/lib/conntrackd/lock
    state: absent
  when: not conntrackd_running
  tags: [nat_conntrack]

- name: Wait 1s before conntrackd pre-flight (iface settles)
  ansible.builtin.wait_for:
    timeout: 1
  when: not conntrackd_running
  tags: [nat_conntrack]

# Use the correct syntax: `conntrackd -C <configfile>`
- name: Validate conntrackd config (pre-flight, only if not running)
  ansible.builtin.shell: "timeout 5s conntrackd -C /etc/conntrackd/conntrackd.conf -d -f"
  args:
    executable: /bin/bash
  register: conntrackd_validate
  changed_when: false
  failed_when: conntrackd_validate.rc != 0
  when: not conntrackd_running
  tags: [nat_conntrack]

- name: Fail with clear message if conntrackd pre-flight failed
  ansible.builtin.fail:
    msg: |
      conntrackd pre-flight failed on {{ inventory_hostname }}.
      rc={{ conntrackd_validate.rc }}
      stdout: {{ conntrackd_validate.stdout | default('') }}
      stderr: {{ conntrackd_validate.stderr | default('') }}
      Hints:
        - "Cannot assign requested address": ct_local_ip must be present on {{ vlan_if }},
          and it must match IPv4_address in conntrackd.conf.
        - Ensure nftables didn’t drop traffic during reload; retry once.
        - If a stale lock exists, remove /var/lib/conntrackd/lock.
  when:
    - not conntrackd_running
    - conntrackd_validate.rc != 0
  tags: [nat_conntrack]

# ---------------------------
# Service enablement
# ---------------------------
- name: Ensure conntrackd enabled and started
  ansible.builtin.systemd:
    name: conntrackd
    state: started
    enabled: yes
  tags: [nat_conntrack]
