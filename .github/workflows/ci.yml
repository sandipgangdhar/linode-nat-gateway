name: CI

on:
  push:
    branches: [ main, feature/** ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  lint-and-validate:
    name: Terraform + Ansible + Docs checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Terraform ----------
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Terraform fmt (check)
        working-directory: terraform
        run: terraform fmt -recursive -check

      - name: Terraform init (no backend)
        working-directory: terraform
        run: terraform init -backend=false

      - name: Terraform validate
        working-directory: terraform
        run: terraform validate -no-color

      # ---------- Python + Ansible toolchain (pins to compatible set) ----------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible toolchain (compatible pins)
        run: |
          python -m pip install --upgrade pip
          # ansible 9.6.0 bundles ansible-core 2.16.x (compatible with ansible-lint 24.2.0)
          pip install "ansible==9.6.1" "ansible-lint==24.2.0" "yamllint==1.35.1"
          ansible --version
          python - <<'PY'
          import ansible, sys
          print("ansible package:", ansible.__version__)
          print("python:", sys.version)
          PY

      # ---------- Ansible / YAML lint ----------
      - name: Ansible Lint (targeted)
        run: |
          ansible-lint -v \
            ansible/site.yml \
            ansible/roles/nat_ha

      - name: YAML lint (repo)
        run: yamllint -s .

      # ---------- Markdown / links ----------
      - name: Check links in Markdown (lychee)
        uses: lycheeverse/lychee-action@v1
        with:
          args: >-
            --verbose
            --no-progress
            --exclude-mail
            --accept 200,204,206,429
            --retry-wait-time 2
            --timeout 20
            --max-concurrency 5
            README.md docs/*.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
